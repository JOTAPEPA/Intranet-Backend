<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de Carpetas - Compras</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.delete {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        #output {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        
        #output h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        #result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
        }
        
        .folder-tree {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .folder-item {
            padding: 5px 10px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .folder-item:hover {
            background: #e9ecef;
        }
        
        .folder-item.selected {
            background: #667eea;
            color: white;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÇÔ∏è Sistema de Administraci√≥n de Carpetas - TEST</h1>
        
        <div class="grid">
            <!-- 1. Obtener Estructura -->
            <div class="card">
                <h2>üìÇ 1. Obtener Estructura de Carpetas</h2>
                <button onclick="getFolderStructure()">Cargar Estructura</button>
                <div id="folderTree" class="folder-tree" style="display:none;"></div>
            </div>
            
            <!-- 2. Crear Carpeta -->
            <div class="card">
                <h2>‚ûï 2. Crear Carpeta</h2>
                <div class="form-group">
                    <label>Nombre de la Carpeta:</label>
                    <input type="text" id="folderName" placeholder="Ej: Contratos">
                </div>
                <div class="form-group">
                    <label>Carpeta Padre:</label>
                    <input type="text" id="parentPath" value="/" placeholder="/">
                </div>
                <button onclick="createFolder()">Crear Carpeta</button>
            </div>
            
            <!-- 3. Subir Documento -->
            <div class="card">
                <h2>üì§ 3. Subir Documento</h2>
                <div class="form-group">
                    <label>T√≠tulo del Documento:</label>
                    <input type="text" id="docTitle" placeholder="Ej: Contrato ABC">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <textarea id="docDesc" placeholder="Descripci√≥n opcional"></textarea>
                </div>
                <div class="form-group">
                    <label>Carpeta Destino:</label>
                    <input type="text" id="docFolder" value="/" placeholder="/">
                </div>
                <div class="form-group">
                    <label>Archivos:</label>
                    <input type="file" id="docFiles" multiple>
                </div>
                <button onclick="uploadDocument()">Subir Documento</button>
            </div>
            
            <!-- 4. Listar Documentos -->
            <div class="card">
                <h2>üìã 4. Listar Documentos</h2>
                <div class="form-group">
                    <label>Filtrar por Carpeta:</label>
                    <input type="text" id="filterFolder" placeholder="/ (dejar vac√≠o para todos)">
                </div>
                <div class="form-group">
                    <label>Buscar:</label>
                    <input type="text" id="searchText" placeholder="Texto a buscar">
                </div>
                <button onclick="getDocuments()" class="secondary">Listar Documentos</button>
            </div>
            
            <!-- 5. Mover Documento -->
            <div class="card">
                <h2>üîÑ 5. Mover Documento</h2>
                <div class="form-group">
                    <label>ID del Documento:</label>
                    <input type="text" id="moveDocId" placeholder="ID del documento">
                </div>
                <div class="form-group">
                    <label>Carpeta Destino:</label>
                    <input type="text" id="moveTarget" placeholder="/">
                </div>
                <button onclick="moveDocument()" class="secondary">Mover Documento</button>
            </div>
            
            <!-- 6. Eliminar Carpeta -->
            <div class="card">
                <h2>üóëÔ∏è 6. Eliminar Carpeta</h2>
                <div class="form-group">
                    <label>Path de la Carpeta:</label>
                    <input type="text" id="deleteFolderPath" placeholder="/Carpeta/">
                </div>
                <button onclick="deleteFolder()" class="delete">Eliminar Carpeta</button>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">
                    ‚ö†Ô∏è Solo se pueden eliminar carpetas vac√≠as
                </p>
            </div>
        </div>
        
        <!-- Output -->
        <div id="output">
            <h2>üìä Resultados</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="folderCount">-</div>
                    <div class="stat-label">Carpetas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="docCount">-</div>
                    <div class="stat-label">Documentos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastAction">-</div>
                    <div class="stat-label">√öltima Acci√≥n</div>
                </div>
            </div>
            <div id="result">
                <span class="info">Esperando acci√≥n...</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api/compras';
        let folderStructure = {};
        
        function updateStats(action) {
            document.getElementById('lastAction').textContent = action;
        }
        
        function showResult(data, success = true) {
            const resultDiv = document.getElementById('result');
            const className = success ? 'success' : 'error';
            resultDiv.innerHTML = `<div class="${className}">${JSON.stringify(data, null, 2)}</div>`;
        }
        
        // 1. Obtener estructura de carpetas
        async function getFolderStructure() {
            try {
                const response = await fetch(`${API_URL}/folders`);
                const result = await response.json();
                
                if (result.success) {
                    folderStructure = result.data;
                    showResult(result.data);
                    updateStats('‚úÖ Estructura Cargada');
                    
                    // Actualizar contador
                    document.getElementById('folderCount').textContent = Object.keys(folderStructure).length;
                    
                    // Mostrar √°rbol
                    displayFolderTree();
                } else {
                    showResult(result, false);
                }
            } catch (error) {
                showResult({ error: error.message }, false);
            }
        }
        
        function displayFolderTree() {
            const treeDiv = document.getElementById('folderTree');
            treeDiv.style.display = 'block';
            treeDiv.innerHTML = '';
            
            const sortedPaths = Object.keys(folderStructure).sort();
            
            sortedPaths.forEach(path => {
                const folder = folderStructure[path];
                const depth = (path.match(/\//g) || []).length - 1;
                const indent = '&nbsp;&nbsp;&nbsp;&nbsp;'.repeat(depth);
                
                const div = document.createElement('div');
                div.className = 'folder-item';
                div.innerHTML = `${indent}üìÅ ${folder.name} <span style="color: #999;">(${folder.documents.length} docs)</span>`;
                div.onclick = () => {
                    document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    document.getElementById('parentPath').value = path;
                    document.getElementById('docFolder').value = path;
                    document.getElementById('moveTarget').value = path;
                    document.getElementById('filterFolder').value = path;
                };
                
                treeDiv.appendChild(div);
            });
        }
        
        // 2. Crear carpeta
        async function createFolder() {
            const name = document.getElementById('folderName').value;
            const parentPath = document.getElementById('parentPath').value;
            
            if (!name) {
                alert('Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, parentPath })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(result);
                    updateStats('‚úÖ Carpeta Creada');
                    document.getElementById('folderName').value = '';
                    
                    // Recargar estructura
                    setTimeout(getFolderStructure, 500);
                } else {
                    showResult(result, false);
                    updateStats('‚ùå Error');
                }
            } catch (error) {
                showResult({ error: error.message }, false);
                updateStats('‚ùå Error');
            }
        }
        
        // 3. Subir documento
        async function uploadDocument() {
            const title = document.getElementById('docTitle').value;
            const desc = document.getElementById('docDesc').value;
            const folderPath = document.getElementById('docFolder').value;
            const files = document.getElementById('docFiles').files;
            
            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }
            
            if (files.length === 0) {
                alert('Por favor selecciona al menos un archivo');
                return;
            }
            
            const formData = new FormData();
            formData.append('documento', title);
            formData.append('descripcion', desc);
            formData.append('folderPath', folderPath);
            
            for (let file of files) {
                formData.append('documentos', file);
            }
            
            try {
                const response = await fetch(`${API_URL}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(result);
                    updateStats('‚úÖ Documento Subido');
                    
                    // Limpiar formulario
                    document.getElementById('docTitle').value = '';
                    document.getElementById('docDesc').value = '';
                    document.getElementById('docFiles').value = '';
                    
                    // Recargar estructura
                    setTimeout(getFolderStructure, 500);
                } else {
                    showResult(result, false);
                    updateStats('‚ùå Error');
                }
            } catch (error) {
                showResult({ error: error.message }, false);
                updateStats('‚ùå Error');
            }
        }
        
        // 4. Listar documentos
        async function getDocuments() {
            const folderId = document.getElementById('filterFolder').value;
            const search = document.getElementById('searchText').value;
            
            let url = `${API_URL}`;
            const params = new URLSearchParams();
            
            if (folderId) params.append('folderId', folderId);
            if (search) params.append('search', search);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            try {
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    showResult(result.data);
                    updateStats('‚úÖ Documentos Cargados');
                    document.getElementById('docCount').textContent = result.data.length;
                } else {
                    showResult(result, false);
                    updateStats('‚ùå Error');
                }
            } catch (error) {
                showResult({ error: error.message }, false);
                updateStats('‚ùå Error');
            }
        }
        
        // 5. Mover documento
        async function moveDocument() {
            const documentId = document.getElementById('moveDocId').value;
            const targetFolderPath = document.getElementById('moveTarget').value;
            
            if (!documentId) {
                alert('Por favor ingresa un ID de documento');
                return;
            }
            
            if (!targetFolderPath) {
                alert('Por favor ingresa una carpeta destino');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/${documentId}/move`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetFolderPath })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(result);
                    updateStats('‚úÖ Documento Movido');
                    
                    // Recargar estructura
                    setTimeout(getFolderStructure, 500);
                } else {
                    showResult(result, false);
                    updateStats('‚ùå Error');
                }
            } catch (error) {
                showResult({ error: error.message }, false);
                updateStats('‚ùå Error');
            }
        }
        
        // 6. Eliminar carpeta
        async function deleteFolder() {
            const folderPath = document.getElementById('deleteFolderPath').value;
            
            if (!folderPath || folderPath === '/') {
                alert('No se puede eliminar la carpeta ra√≠z');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de eliminar la carpeta ${folderPath}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/folders/${encodeURIComponent(folderPath)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(result);
                    updateStats('‚úÖ Carpeta Eliminada');
                    document.getElementById('deleteFolderPath').value = '';
                    
                    // Recargar estructura
                    setTimeout(getFolderStructure, 500);
                } else {
                    showResult(result, false);
                    updateStats('‚ùå Error');
                }
            } catch (error) {
                showResult({ error: error.message }, false);
                updateStats('‚ùå Error');
            }
        }
        
        // Cargar estructura al iniciar
        window.onload = () => {
            getFolderStructure();
        };
    </script>
</body>
</html>
